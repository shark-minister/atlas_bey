ベイブレードXのマイコン制御電動ランチャーシステムのソースコードです。以下の点にご留意ください。

- 本稿の図は、ソフトウェアの画面キャプチャを除き、すべて私 "さめ大臣 / shark minister" が実物を元に書き起こしたものです。これらの図の、無断での複製や配布、改変などはご遠慮ください。
- 本稿を参考に製作や運転をされる場合は、自己責任のもとで実施お願いします。それによって生じたトラブル等については、いかなる責任も負いかねます。
- 私 "さめ大臣 / shark minister" は電子工作・電気工作の素人につき、ところどころ間違っている恐れがあります。プログラミングも趣味レノレベルを超えません。全てを鵜呑みにするのは危険かもしれませんので、その点をご注意くだされば幸いです。

# 1. はじめに

マイコン制御電動ランチャーシステムATLAS（**A**u**T**omatic **LA**unching **S**ystem）は、タカラトミーが販売するベイブレードXの遊び・練習を充実させるため、電動ランチャー（モーターによるベイブレード射出機）をマイコンで制御し、リアルのシュートジムを実現してみようと開発したシステムです。

ATLASでは、ランチャーにベイをセットしたら自動で検知してカウントダウン（3, 2, 1, ゴー、シュート！）を行ってからベイブレード射出を行う「オートモード」と、電動ランチャーのシュートパワーなどの設定をPCやスマートフォンから行ったり、手動でベイブレード射出を行ったりできる「マニュアル・設定モード」の2つのモードがあります。

ATLASの概略図を下に示します。

<p align="center">
<img width="900" alt="マイコン制御電動ランチャー" src="https://github.com/user-attachments/assets/f4939f6f-cd0b-48d6-a4a3-ab32b006a0d5" />
</p>

# 2. 使い方

ATLASのマイコンへはUSB-Cで電力を供給します。
立ち上がると1～2秒、スプラッシュスクリーンが表示され、切替スイッチにしたがったモードの画面が表示されます。
モード切替は電源が入った状態でも行えます。

## 2-1. オートモード

### 2-1-1. 概要

オートモードは、主に「人」vs「電動ランチャー」で遊ぶモードです。
ベイバトルパスを装着したランチャーにベイをセットするとそれを検知して自動でカウントダウン（3, 2, 1, ゴー、シュート！）を行い、電動ランチャーにセットされたベイが射出されます。
また、モーター（電動ランチャー）を連動させずに単なるシュートパワー計測機としても使うことができます。

**機能**
- ベイバトルパスとの連動
  - ブレーダーのシュートパワーを表示
  - ブレーダーのシュート解析、序盤の加速度を計算・表示
- 電動ランチャーによる自動射出
  - 自分のランチャーにベイをセットすることでカウントダウンを開始し射出

オートモードでは**ベイバトルパス**が必須となります。

> タカラトミー BX-09 ベイバトルパス  
> https://beyblade.takaratomy.co.jp/beyblade-x/lineup/bx09.html

**画面の見方**

オートモードのディスプレイ表示は以下の通りです。

<p align="center">
<img width="200" alt="オートモード画面" src="https://github.com/user-attachments/assets/830a536d-1dfa-4d40-8787-2180f7dcdd38" />
</p>

表示の詳細は以下の通りです。

- ヘッダ領域
  - `P` バトルパスが接続されているか。接続が切れると`P`マークは消えます
  - `B` ベイブレードがランチャーにセットされているか。ベイブレードが外れると`B`マークは消えます
  - `max` 最大SP値
  - `n` シュート数
  - `avg`　平均SP値（標準偏差含む）
- `YOUR SP` ブレーダーのシュートパワー
- フッタ領域
  - `Acc.`　シュートの加速度（最初の8回転分の最小二乗法）
  - `Exp.SP`　新品のストリングランチャーを用いて、前半の加速度を維持したまま引き切ったときに期待されるシュートパワー

### 2-1-2. ベイバトルパスの接続・切断

オートモードの最初には、ベイバトルパス（以下、BBP）の接続を促すメッセージが表示されます。

<p align="center">
<img width="200" alt="オートモード画面" src="https://github.com/user-attachments/assets/66b89fcd-44bd-4565-abb5-1892a15ef57d" />
</p>

BBPの電源を投入し、BBPの天面ボタンを長押しすることで接続依頼（Bluetoothのアドバタイズ）を行います。ATLASがそれを検知し接続が完了するとBBPのインジケータが緑色の点滅を行います（スマホのベイブレードアプリへの接続と同じです）。また、その際に画面表示が変わって、画面上部のヘッダ領域に`P`が表示されます。

<p align="center">
<img width="200" alt="オートモード画面" src="https://github.com/user-attachments/assets/a4b3044b-256a-4655-be5d-9eedc6dcbdc9" />
</p>

BBPを切断したいときはBBPのボタンを長押ししてください。インジケータが赤色の点滅を行ったら切断成功です。ヘッダ領域の`P`マークが消えることを確認してください。

### 2-1-3. シュートパワーの計測をしたいだけのときは

オートモード起動直後は、安全のためモーターが無効にされています。この状態では、電動ランチャーを連動させずに単なるシュートパワー計測機として使うことができます。ベイをランチャー（BBPは接続済み）にセットするとATLASはそれを感知し、画面上部のヘッダ領域に`B`マークがつきます。ベイを外すと`B`マークは消えます。

<p align="center">
<img width="200" alt="オートモード画面" src="https://github.com/user-attachments/assets/a7b67763-7017-4e4f-935a-314cfa496bf2" />
</p>

ベイのシュートを行うと、画面にシュートパワーが表示されます。

<p align="center">
<img width="200" alt="オートモード画面" src="https://github.com/user-attachments/assets/350990ad-8a83-46b5-b0e4-be0398c973e2" />
</p>

シュートパワー以外にも、シュートの加速度（Acc）と、新品のストリングランチャーを用いて、前半の加速度を維持したまま引き切ったときに期待されるシュートパワー（Exp.SP）を画面下部に表示しています。
シュート加速度は最初の8回転分の最小二乗法で求めています。あくまで参考値としてご利用ください。

ベイバトルパスからのデータが正しく送受信されないとチェックサムエラーとなり、画面にERRORと表示されます。

<p align="center">
<img width="200" alt="オートモード画面" src="https://github.com/user-attachments/assets/3b573def-1101-4f4c-9d66-145f985665b4" />
</p>

### 2-1-4. 電動ランチャーを用いるときは

電動ランチャーの射出するベイとバトルしたい場合はモーターを有効にする必要があります。モーターを有効にするには、ランチャーにベイがセットされていない状態でBBPのボタンを2連続で押してください（ダブルクリック）。モーターが有効になるとヘッダ領域に電動ランチャーの情報（番号と回転方向）が表示されます。下の図の例だと、電動ランチャー1が有効で、右回転に設定されています。

<p align="center">
<img width="200" alt="オートモード画面" src="https://github.com/user-attachments/assets/6f18a478-5b39-4a45-9fbd-85f3c4422736" />
</p>

この状態でベイをセットすると、ディスプレイに**ReadySet**と大きく表示されます。

<p align="center">
<img width="200" alt="オートモード画面" src="https://github.com/user-attachments/assets/2ed11b5a-5e21-4d7f-8861-6002c4005a41" />
</p>

ReadySetが表示されている間にベイをランチャーから外すと、電動ランチャー駆動（モーターの回転開始）がキャンセルされます。このキャンセル可能な時間を猶予時間（レイテンシ, latency）と呼び、デフォルトでは1.3秒間で設定されています。猶予時間の値はマニュアル・設定モードで変更することができます（詳細はマニュアル・設定モードを参照）。

<p align="center">
<img width="200" alt="オートモード画面" src="https://github.com/user-attachments/assets/3d7dcd3e-620e-4e61-b018-c2c0dcbbd36b" />
</p>

ベイを外さないでおくとカウントダウンが始まりますので、号令にあわせて自分のシュートを行ってください。電動ランチャーは設定にしたがってベイの射出を行います。ディスプレイには自分のシュートパワーが表示されます。画面の見方は、前述の電動ランチャー無効状態でのシュートパワー測定と同じです（エラー表示も同様）。

<p align="center">
<img width="200" alt="オートモード画面" src="https://github.com/user-attachments/assets/a5f025cc-f72e-4af4-bad7-2eea0a779b42" />
</p>

## 2-2. マニュアル・設定モード

### 2-2-1. 概要

マニュアル・設定モードは、電動ランチャーの設定を行ったり、電動ランチャー単体で遊ぶモード（手動での操作）です。

**機能**
- 電動ランチャーの設定
  - シュートパワー
  - 回転方向 L/R
  - 有効・無効
- オートモードの設定
  - ベイ射出決定猶予時間（Readysetと3の合図の間の時間）
    - この時間内であれば、射出キャンセルが可能
  - 射出遅延時間（Shoot!の合図からの遅延時間）
  - 使用する電動ランチャー

マニュアル・設定モードでは、ATLASとBluetooth接続するため**PC/タブレット/スマートフォン**が必須となります。

### 2-2-2. デバイス側

マニュアルモードのディスプレイ表示は以下の通りです。

<p align="center">
<img width="200" alt="マニュアル・設定モード画面" src="https://github.com/user-attachments/assets/e93d3d98-007a-4665-8e1e-783617f59eb7" />
</p>

表示の詳細は以下の通りです。

- ヘッダ領域
  - `CLI` PCやスマホなどのクライアントが接続されているか。`CLI`の下に＊マークがつきます。接続が切れると＊マークは消えます
  - `LATENCY` オートモードにおける電動ランチャー駆動（モーターの回転開始）のキャンセル可能な時間を猶予時間。ミリ秒単位
  - `DELAY` オートモードにおけるカウントダウン最後の "Shoot!" の言い始めとモーター停止（ベイ射出）の間隔（射出遅延）。ミリ秒単位
- 電動ランチャーの設定
  - `ENABLED` オートモード／マニュアル・設定モードでの電動ランチャーの有効・無効
    - `A` オートモードで用いる電動ランチャーに指定されている（排他的）
    - `M` マニュアルモードで用いる電動ランチャーに指定されている
  - `ROTATION` 回転方向
    - `R` 右回転
    - `L` 左回転
  - `S.POWER` シュートパワー
- シュートの統計データ
  - `MAX` 最大SP値
  - `MIN` 最小SP値
  - `AVG` 平均SP値
  - `STD` SP値の標準偏差
  
### 2-2-3. クライアント側

ここでは、ATLASと通信するPC、スマホ等で動作させるクライアントソフトウェアについて記述します。
クライアントソフトウェアはWebアプリとして実装してあります。
Web Bluetooth APIがChromeでしか動かないため、Chromeをお使いください。

デバイスとの通信アプリは以下のULRにアクセスすると使えます。

https://shark-minister.github.io/atlas_bey/

ページを開くと次の画面が現れます。

<p align="center">
  <img width="400" alt="image" src="https://github.com/user-attachments/assets/0574f447-35fa-49a0-90cb-3342439eda61" />
</p>

#### 接続

デバイスをマニュアル/設定モードに切り替えた状態で、〔接続する〕ボタンをクリックしてください。

<p align="center">
<img width="327" alt="接続" src="https://github.com/user-attachments/assets/83f76098-71ba-4580-891c-90e430cafa72" />
</p>

ATLAS_AUTO_LAUNCHER（Arduionと表示される場合もあり）を選んで〔ペア設定〕をクリックするとデバイスが接続されます。接続されると自動的にデバイスのパラメータが読み込まれます。

もしデバイスが2台のモーターを稼働させる状態になっている場合、以下の設定画面（後述）は以下の通りになります。

<p align="center">
<img width="450" alt="Webクライアント画面2" src="https://github.com/user-attachments/assets/e34c50bf-66e0-40b0-8ac8-9efbb46c6169" />
</p>

#### 切断

〔接続する〕ボタンをクリックすれば、デバイスとの接続を切断できます。

#### マニュアル制御

〔ベイを射出する〕ボタンを押すとモータにセットされたベイが射出されます。

#### 設定

- 回転方向: モーターの回転方向を設定します。Rが右回転、Lが左回転です。
- シュートパワー: モーターの回転数を設定します。値は100の倍数である必要があります。
- 猶予時間: 猶予時間をミリ秒単位で設定します。値は10の倍数である必要があります。
- 遅延時間: 遅延時間をミリ秒単位で設定します。値は2の倍数である必要があります。
- ROMに書き込み: 有効であるとき、書き込み時にデバイスのフラッシュメモリに保存され、次回起動するときにそのパラメータになります。
- 〔読み出す〕ボタン: デバイスで動いているパラメータを読み込みます。
- 〔書き込む〕ボタン: デバイスにパラメータを送ります。


#### シュート情報

デバイスに保存されているシュートパワー統計情報を読み込んで、グラフ表示を行います。

- 〔読み出す〕ボタン: シュートパワー統計情報を読み込んで、グラフ表示を行う。
- 〔初期化〕ボタン: デバイスに保存されているシュート統計情報をクリアする。

<p align="center">
<img width="400" alt="シュート統計" src="https://github.com/user-attachments/assets/e2cfac98-4329-4645-807c-b00e8559282e" />
</p>

<p align="center">
<img width="400" alt="シュート統計グラフ" src="https://github.com/user-attachments/assets/24b154a9-f7f1-42e2-b9f0-294583851bf6" />
</p>

# 4. ハードウェア

## 4-1. 構成部品

### 4-1-1. 制御系

制御系の部品は以下の通りです。

- **マイコン**
  - Seeed Studio XIAO ESP32-C3
  - Bluetooh Low Energy対応のコンパクトなマイコン
  - 秋月電子: https://akizukidenshi.com/catalog/g/g117454/
  - スイッチサイエンス: https://www.switch-science.com/products/8348
  - 電子工作ステーション: https://electronicwork.shop/items/64fb421a4adc32002be4fa50
- **オーディオモジュール**
  - DFPlayer Mini
  - MicroSDカードに保存した音声ファイルを再生できるモジュール。互換品もあるが、Arduino以外で動かないという報告もあるので、正規品が無難
  - 秋月電子: https://akizukidenshi.com/catalog/g/g112544/
  - スイッチサイエンス: https://www.switch-science.com/products/4291
  - 電子工作ステーション: https://electronicwork.shop/items/639fc4a36b87c328989fcec5
  - 音声ファイルを格納しておく microSD カードが別途必要です。
- **ディスプレイ**
  - SH1106 (1.3" OLED)
  - Adafruit製のドライバーで制御できる 128x64 のディスプレイ
  - 単色ですが、色はいろいろあるようなのでお好みで
  - Amazon.co.jp: https://www.amazon.co.jp/dp/B0D9BKWX4H/ 他
  - SSD1306 (0.96" OLED) も使用可能（一部ソースコードの書き換えが必要。5-2-2節参照）
- **モータードライバー**
  - 12A対応のPWMモータードライバー
  - DAOKAI BTS7960など
  - Amazon.co.jp: https://www.amazon.co.jp/dp/B0B82GXBYF/ 他
  - モーターを2台接続する場合は、モータードライバーも2つ必要
- **スピーカー**
  - Wattsの500円スピーカーを分解して使いました。なんでも良いと思います（ホント？）。
- **スイッチ**
  - 3ピン2ポジションのトグルスイッチか、スライドスイッチ
- **ジャンプワイヤー等のケーブル**

<p align="center">
<img width="700" alt="ctrl_devices" src="https://github.com/user-attachments/assets/49496c3c-64a1-4331-9c0e-33a245529d0a" />
</p>

### 4-1-2. 駆動系

駆動系の部品は以下の通りです。

1. **モーター**
   - タミヤ OP.1393 380 スポーツチューンモーター
   - シャフト径2.3→3.175mmのピニオン変換アダプタが付属
   - Amazon.co.jp: https://www.amazon.co.jp/dp/B008GY168C/
2. **ピニオン変換アダプタ**
   - シャフト径を3.175mm→5mmに変換するアダプタ
   - Amazon.co.jp: https://www.amazon.co.jp/dp/B0CMPS81FP/
3. **カップラ**
   - 5mmφのシャフトをM4に変換
   - Amazon.co.jp: https://www.amazon.co.jp/dp/B08NP39Y31/
4. **ベイブレードXランチャーの爪部分**
5. **M4ネジ**
   - ランチャーの爪をカップラに固定するためのネジ
   - 10mm未満がよい
   - スペーサーとしてナットが必要になる場合も
6. **電源**
   - 7.2V, 10Aを供給できる安定化電源
   - DROKスイッチング電源 0-12V / 20A など
   - Amazon.co.jp: https://www.amazon.co.jp/dp/B0B74NT7PR/
7. **モーター用ケーブル**
   - 2芯1.25sq VCT-F ケーブル
   - 電源・モータードライバー・モーター間の配線に使用する
   - ホームセンターで、切り売り 24円@10cm程度、5m梱包で750円程度
8. **電源ケーブル**
   - 片側がプラグになっている2芯1.25sqのケーブル
   - Amazon.co.jp: https://www.amazon.co.jp/dp/B00FIXSEO8/

1-5のパーツは下記のように組み立てます。

<p align="center">
<img width="500" alt="motor-assembly" src="https://github.com/user-attachments/assets/157866d5-f824-499b-b0a5-4d10ab48a274" />
</p>

完成すると以下の図のようになります。左回転用は別途用意するか、ランチャーの爪を付け替えます。

<p align="center">
<img width="300" alt="motor-assembly" src="https://github.com/user-attachments/assets/75785a5a-2328-434d-92a8-1d6b6a12c47d" />
</p>

> [!NOTE]
> 3Dプリンタが使える人は、ランチャーの爪と2.3mmシャフトを繋ぐアダプタを自作した方が早いかも知れません。

### 4-1-3. その他

- **マジックアーム**
  - モーターを固定するためのジグ。両端にクランプが必要
  - モーターの間にゲルテープ（百均で売っている）を巻き、クランプで挟む

### 4-1-4. 音声データ

音声データは、現状で4つです。

- 01: カウントダウン音声（3, 2, 1, Go, shoot）
- 02: 成功の効果音
- 03: キャンセルの効果音
- 04: エラーの効果音

microSDカードに 01, 02, 03, 04のフォルダを作成し、それぞれのフォルダの中に001.mp3という名でファイルを保存してください。
カウントダウン音声の号令間隔は1秒です。

## 4-2. 配線

下の図の通り配線しました。

<p align="center">
<!-- <img width="700" alt="system-wiring" src="https://github.com/user-attachments/assets/5ce717db-b21d-435d-a943-38eb230eeeee" /> -->
<img width="700" alt="system-wiring" src="https://github.com/user-attachments/assets/442bdb62-de9c-4cbf-b16b-3efee3359d2d" />
</p>

### 4-2-1. BTS79608

モータードライバー BTS79608 の配線は以下の通りです。

> [!IMPORTANT]
> モータードライバーと電源・モーター間のケーブルは大きい電流が流れるので、1.25sq以上の太さのケーブルを使ってください。
> ホームセンターで販売している2芯1.25sqのケーブルの両端の被覆を剥いて、2本の線（白と黒）をそれぞれ＋と－で用いれば動力系の配線がすっきりします。

<table>
  <tr>
    <th>BTS79608</th>
    <th>ESP32-C3</th>
    <th>モーター</th>
    <th>電源 (7.2V)</th>
  </tr>
  <tr>
    <td>LPWM</td>
    <td>GPIO2</td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td>RPWM</td>
    <td>GPIO3</td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td>L_EN</td>
    <td>GPIO4</td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td>R_EN</td>
    <td>GPIO4</td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td>M＋</td>
    <td></td>
    <td>＋</td>
    <td></td>
  </tr>
  <tr>
    <td>M－</td>
    <td></td>
    <td>－</td>
    <td></td>
  </tr>
  <tr>
    <td>＋</td>
    <td></td>
    <td></td>
    <td>＋</td>
  </tr>
  <tr>
    <td>－</td>
    <td></td>
    <td></td>
    <td>－</td>
  </tr>
</table>

### 4-2-2. SH1106 / SSD1306 (I2C)

ディスプレイ SH1106 / SSD1306 (I2C) の配線は以下の通りです。

<table>
  <tr>
    <th>SH1106 / SSD1306</th>
    <th>ESP32-C3</th>
  </tr>
  <tr>
    <td>VCC</td>
    <td>3V3 (3.3V)</td>
  </tr>
  <tr>
    <td>GND</td>
    <td>GND</td>
  </tr>
  <tr>
    <td>SCL</td>
    <td>SCL</td>
  </tr>
  <tr>
    <td>SDA</td>
    <td>SDA</td>
  </tr>
</table>

### 4-2-3. DFPlayer Mini

音楽プレーヤー DFPlayer Mini の配線は以下の通りです。

<table>
  <tr>
    <th>DFPlayer Mini</th>
    <th>ESP32-C3</th>
    <th>スピーカー</th>
  </tr>
  <tr>
    <td>VCC</td>
    <td>3V3 (3.3V)</td>
    <td></td>
  </tr>
  <tr>
    <td>GND</td>
    <td>GND</td>
    <td></td>
  </tr>
  <tr>
    <td>RX</td>
    <td>TX</td>
    <td></td>
  </tr>
  <tr>
    <td>TX</td>
    <td>RX</td>
    <td></td>
  </tr>
  <tr>
    <td>SPK_1</td>
    <td></td>
    <td>＋</td>
  </tr>
  <tr>
    <td>SPK_2</td>
    <td></td>
    <td>－</td>
  </tr>
</table>

### 4-2-4. スイッチ

スイッチの配線は以下の通りです。

<table>
  <tr>
    <th>スイッチ</th>
    <th>ESP32-C3</th>
  </tr>
  <tr>
    <td>AUTO側のピン</td>
    <td>3V3 (3.3V)</td>
  </tr>
  <tr>
    <td>MANUAL側のピン</td>
    <td>GND</td>
  </tr>
  <tr>
    <td>中央のピン</td>
    <td>GPIO4</td>
  </tr>
</table>

# 5. ソフトウェア

ここでは、マイコンで動作するプログラムについて記述します。

## 5-1. ビルド環境の準備

### 5-1-1. ArduinoIDEのインストール

本ソースコードは、ArduinoIDEでビルドすることを想定しています。PlatformIOでのビルドは検証していません。
ArduinoIDEをインストールしていない場合は、下記URLから自分のプラットフォーム（OS）にあったものをダウンロードしてインストールしてください。

ArduinoIDEの公式ダウンロードページ：
https://www.arduino.cc/en/software/

### 5-1-2. ボードマネージャのインストール

ボードマネージャから、**esp32 by Espressif Systems**をインストールします。

<p align="center">
<img width="277" alt="board-manager" src="https://github.com/user-attachments/assets/b1cb1103-2dcb-465b-afbf-41d950afb66c" />
</p>

### 5-1-3. ライブラリのインストール

ビルドに当たっては、以下のライブラリが必要になります。

- ArduinoBLE
- Adafruit SH110X（SH1106を使う場合）
- Adafruit SSD1306（SSD1306を使う場合）
- DFRobotDFPlayerMini (DFPlayerMiniを使う場合）

Arduino IDEの場合は、ライブラリマネージャ（左の柱のアイコンの上から3つ目）で、ライブラリ名を検索してインストールできます。

<p align="center">
<img width="363" alt="library" src="https://github.com/user-attachments/assets/e3b88919-343d-44f3-8e0d-880c029fd44d" />
</p>

## 5-2. パラメータの設定値変更

パラメータ設定は、`setting.hh`で行えます。

### 5-2-1.ピン番号設定

- `MODE_SW`
   - 切替スイッチの中央端子と繋ぐピン番号
   - デフォルト値: 8
- `L_PWM_1` 
   - モータードライバー1のL_PWMをつなぐGPIOピン番号
   - デフォルト値: 2
   - 左回転用PWM
- `R_PWM_1` 
   - モータードライバー1のR_PWMをつなぐGPIOピン番号
   - デフォルト値: 3
   - 右回転用PWM
- `LR_EN_1` 
   - モータードライバー1のL_ENとR_ENをつなぐGPIOピン番号
   - デフォルト値: 4
- `L_PWM_2` 
   - モータードライバー2のL_PWMをつなぐGPIOピン番号
   - デフォルト値: 9
   - 左回転用PWM、コメントアウト済み、未検証
- `R_PWM_2` 
   - モータードライバー2のR_PWMをつなぐGPIOピン番号
   - デフォルト値: 10
   - 右回転用PWM、コメントアウト済み、未検証
- `LR_EN_2` 
   - モータードライバー2のL_ENとR_ENをつなぐGPIOピン番号
   - デフォルト値: 5
   - コメントアウト済み、未検証
- `SCREEN_SPI_MOSI`
   - SSD1309のSDAをつなぐGPIOピン番号（MOSI）
   - デフォルト値: 10
- `SCREEN_SPI_DC`
   - SSD1309のDCをつなぐGPIOピン番号（MISO）
   - デフォルト値: 9
- `SCREEN_SPI_CLK`
   - SSD1309のSCLをつなぐGPIOピン番号（SCK）
   - デフォルト値: 8
- `SCREEN_SPI_CS`
   - SSD1309のCSをつなぐGPIOピン番号（SS）
   - デフォルト値: 20
- `SCREEN_SPI_RESET`
   - SSD1309のRESをつなぐGPIOピン番号（RESET）
   - デフォルト値: 7

> [!CAUTION]
> モーター2台体制は未検証です。

### 5-2-2.ディスプレイ設定

ディスプレイにSSD1306を使用する場合、`DISPLAY_MODEL`を`ADAFRUIT_SSD1306`に変更してください。

- `SCREEN_WIDTH`
  - スクリーンの幅
  - デフォルト値: 128
- `SCREEN_HEIGHT`
  - スクリーンのt高さ
  - デフォルト値: 64
- `SCREEN_ADDR`
  - I2Cアドレス
  - デフォルト値: 0x3C
- `DISPLYA_IS_SPI`
  - ディスプレイがSPI接続のときは1，I2Cのときは0
- `DISPLAY_DRIVER`
  - ディスプレイのモデル。以下のいずれかの値をとる
  - ADAFRUIT_SSD1306: SSD1306を使う場合
  - ADAFRUIT_SH1106G: SH1106Gを使う場合

### 5-2-3. モーター設定

- `MOTOR1_MAX_RPM`
  - モーター1の最大回転数
  - デフォルト値: 24,900
- `MOTOR2_MAX_RPM`
  - モーター2の最大回転数
  - デフォルト値: 24,900
- `NUM_MOTORS`
  - 使用するモーターの数
  - デフォルト値: 1
- `USE_DUMMY_MOTOR`
  - モーターをダミーモードにする。デバッグ用。モータードライバーに接続せず、Serial通信でデバッグ文を出力するのみとなる。
  - デフォルト値: 0

> [!CAUTION]
> モーターは、タミヤの<ins>OP.1393 380 スポーツチューンモーター</ins>か、<ins>OP.68 RS-540 スポーツチューンモーター</ins>を想定しています。
> それ以外のモーターでは動作を検証していません。

### 5-2-4. 音声設定

- `AUDIO_COUNTDOWN`
  - カウントダウン音声の番号
  — 3, 2, 1, Go, shootの間隔は1秒とする
  - デフォルト値: 1
- `AUDIO_SE_ACK`
  - 成功の効果音の番号
  - デフォルト値: 2
- `AUDIO_SE_CANCEL`
  - キャンセルの効果音の番号
  - デフォルト値: 3 
- `AUDIO_SE_ERROR`
  - エラーの効果音の番号
  - デフォルト値: 4 

### 5-2-5. 動作パラメータ設定

- BLE通信でPC・スマホから変更可能なパラメータのデフォルト値
  - `DEFAULT_LAUNCHER_SP`
    - 電動ランチャーのSPデフォルト値
    - 電動ランチャーでベイを射出するときのシュートパワーSPのデフォルト値を指定する。SPの内部パラメータは、外部からBLE通信で変更できる。
    - デフォルト値: 10,000
  - `DEFAULT_DELAY`
    - 射出遅延時間のデフォルト値 [ms]
    - モーター停止（ベイ射出）の間隔（射出遅延）のデフォルト値をミリ秒で指定する。遅延時間の内部パラメータは、外部からBLE通信で変更できる。
    - デフォルト値: 0
  - `DEFAULT_LATENCY`
    - 猶予時間のデフォルト値 [ms]
    - オートモードでのカウントダウン最初の "ReadySet" と "3" までの間隔のデフォルト値をミリ秒で指定する。この猶予時間内にベイをランチャーから外すとカウントダウンとモーター駆動開始がキャンセルされる。猶予時間の内部パラメータは、外部からBLE通信で変更できる。
    - デフォルト値: 1,300
- ソフトウェアリミット
  - `LAUNCHER_SP_UPPER_LIMIT`
    - 電動ランチャーのSP上限値（ソフトウェアリミット）
    - 電動ランチャーでベイを射出するときのシュートパワーSPの上限値を指定する。モーターの最高回転数以下にすることが望ましい。この値は外部から変更できない。
    - デフォルト値: 24,900
  - `LAUNCHER_SP_LOWER_LIMIT`
    - 電動ランチャーのSP下限値（ソフトウェアリミット）
    - 電動ランチャーでベイを射出するときのシュートパワーSPの下限値を指定する。この値は外部から変更できない。
    - デフォルト値: 3,000
  - `DELAY_UPPER_LIMIT`
    - 射出遅延時間の上限値（ソフトウェアリミット） [ms]
    - オートモードでのカウントダウン最後の "Shoot!" の言い始めとモーター停止（ベイ射出）の間隔（射出遅延）の上限値をミリ秒で指定する。この値は外部から変更できない。
    - デフォルト値: 500
  - `LATENCY_LOWER_LIMIT`
    - 猶予時間の下限値（ソフトウェアリミット） [ms]
    - オートモードでのカウントダウン最初の "ReadySet" と "3" までの間隔の下限値をミリ秒で指定する。この値は外部から変更できない。
    - デフォルト値: 500
- その他
  - `MOTOR_PREPARATORY_TIME`
    - モーター加速の余裕時間 [ms]
    - モーターが最大回転数になるまでにはある程度の時間が必要であり、それを考慮した値をミリ秒で指定する。この値は外部から変更できない。マニュアルモード時のみ使用される。
    - デフォルト値: 2,000
  - `COUNTDOWN_INTERVAL`
    - カウントダウンコールの間隔 [ms]
    - カウントダウンコールは、"3, 2, 1, Go, Shoot!" であり、そのコール間隔をミリ秒で指定する。この値は外部から変更できない。
    - デフォルト値: 1,000

## 5-3. ビルド

ビルドの際は、ボードに**XIAO EPS32-C3**を選んでください。→ボタンを押すとビルドとマイコンへのダウンロードが行われます。

<p align="center">
<img width="292" alt="board1" src="https://github.com/user-attachments/assets/c0856797-581d-4aa2-b261-37cc2aa7429b" />
</p>

## 5-4. ATLASのBLE仕様

ATLASのペリフェラルとしてのGATT仕様は以下の表の通りです。

- ローカル名: ATLAS_01	
- サービスUUID: 32150000-9A86-43AC-B15F-200ED1B7A72A
- キャラクタリスティック
  - **電動ランチャーの設定を取得する・変更する**
    - UUID: 32150001-9A86-43AC-B15F-200ED1B7A72A
    - 型: バイト列（7 bytes）
    - 読み込み・書き込み
  - **現在の設定を本体に保存する**
    - UUID: 32150010-9A86-43AC-B15F-200ED1B7A72A
    - 型: 符号なし整数（1 byte）
    - 書き込み
    - どんな値でも良いので、書くと設定保存が実行される
  - **マニュアルシュート指令**
    - UUID: 32150020-9A86-43AC-B15F-200ED1B7A72A
    - 型: 符号なし整数（1 byte）
    - 書き込み
    - どんな値でも良いので、書くとシュート指令が発行される

電動ランチャー設定（7バイト）のフォーマットは先頭のバイトから、

1. オートモードで使用する電動ランチャーの番号
   - `0`: 電動ランチャー1
   - `1`: 電動ランチャー2
2. オートモードの猶予時間（レイテンシ）
   - 設定したい猶予時間（ミリ秒単位）の**1/10**
3. オートモードの射出遅延時間
   - 設定したい射出遅延時間（ミリ秒単位）の**1/2**
4. 電動ランチャー1のフラグ
   - 最下位から1ビット目（0000 000**1**）: この電動ランチャーをマニュアルモードで使用するかどうか
     - `0`: 使用しない
     - `1`: 使用する
   - 最下位から4ビット目（000**1** 0000）: この電動ランチャーの回転方向
     - `0`: 右回転
     - `1`: 左回転
5. 電動ランチャー1のシュートパワー
   - 設定したいシュートパワーの**1/100**
6. 電動ランチャー2のフラグ
   - 最下位から1ビット目（0000 000**1**）: この電動ランチャーをマニュアルモードで使用するかどうか
     - `0`: 使用しない
     - `1`: 使用する
   - 最下位から4ビット目（000**1** 0000）: この電動ランチャーの回転方向
     - `0`: 右回転
     - `1`: 左回転
7. 電動ランチャー2のシュートパワー
   - 設定したいシュートパワーの**1/100**

となっています。
汎用のBLE通信アプリを使う場合は、デフォルト値で、00-82-00-00-64-00-64（16進数）です。

<img width="600" alt="data-format" src="https://github.com/user-attachments/assets/2cc4bbc6-1144-41cb-8af5-4a32ec97236d" />
